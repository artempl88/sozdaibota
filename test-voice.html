<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src 'self' blob: data: mediastream:; object-src 'none';">
    <meta http-equiv="Permissions-Policy" content="microphone=(self), camera=(self)">
    <title>–¢–µ—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .voice-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        button {
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .start-btn {
            background: #4CAF50;
            color: white;
        }
        .stop-btn {
            background: #f44336;
            color: white;
        }
        .test-btn {
            background: #2196F3;
            color: white;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ –¢–µ—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏</h1>
        
        <div class="voice-controls">
            <button id="testSupportBtn" class="test-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
            <button id="startBtn" class="start-btn" disabled>üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
            <button id="stopBtn" class="stop-btn" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
        
        <div id="status" class="status info">
            –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É" –¥–ª—è –Ω–∞—á–∞–ª–∞
        </div>
        
        <div class="log" id="log">
            <strong>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</strong><br>
            –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...
        </div>
    </div>

    <script>
        class VoiceTester {
            constructor() {
                this.isRecording = false;
                this.mediaRecorder = null;
                this.audioChunks = [];
                
                this.testSupportBtn = document.getElementById('testSupportBtn');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.status = document.getElementById('status');
                this.log = document.getElementById('log');
                
                this.initEventListeners();
            }
            
            initEventListeners() {
                this.testSupportBtn.addEventListener('click', () => this.testSupport());
                this.startBtn.addEventListener('click', () => this.startRecording());
                this.stopBtn.addEventListener('click', () => this.stopRecording());
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `${timestamp}: ${message}`;
                
                this.log.innerHTML += `<br>${logEntry}`;
                this.log.scrollTop = this.log.scrollHeight;
                
                console.log(`[VoiceTester] ${logEntry}`);
            }
            
            setStatus(message, type = 'info') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }
            
            async testSupport() {
                this.log('–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –±—Ä–∞—É–∑–µ—Ä–∞...');
                
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API
                    if (!navigator.mediaDevices) {
                        throw new Error('navigator.mediaDevices –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    }
                    
                    if (!navigator.mediaDevices.getUserMedia) {
                        throw new Error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    }
                    
                    if (!window.MediaRecorder) {
                        throw new Error('MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    }
                    
                    this.log('‚úÖ –í—Å–µ API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                    this.log('–ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...');
                    
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(device => device.kind === 'audioinput');
                    
                    this.log(`–ù–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${audioInputs.length}`);
                    audioInputs.forEach((device, index) => {
                        this.log(`  ${index + 1}. ${device.label || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'}`);
                    });
                    
                    if (audioInputs.length === 0) {
                        throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤');
                    }
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                    this.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    this.log('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!');
                    this.log(`–ê—É–¥–∏–æ —Ç—Ä–µ–∫–∏: ${stream.getAudioTracks().length}`);
                    
                    stream.getAudioTracks().forEach((track, index) => {
                        this.log(`  –¢—Ä–µ–∫ ${index + 1}: ${track.label}, enabled: ${track.enabled}`);
                    });
                    
                    // –°—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫
                    stream.getTracks().forEach(track => track.stop());
                    this.log('–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫ –∑–∞–∫—Ä—ã—Ç');
                    
                    this.setStatus('‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –∑–∞–ø–∏—Å—å.', 'success');
                    this.startBtn.disabled = false;
                    this.testSupportBtn.textContent = '‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OK';
                    this.testSupportBtn.disabled = true;
                    
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                    
                    let helpMessage = '';
                    if (error.name === 'NotAllowedError') {
                        helpMessage = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
                    } else if (error.name === 'NotFoundError') {
                        helpMessage = '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∫ –∫–æ–º–ø—å—é—Ç–µ—Ä—É';
                    } else if (error.name === 'NotReadableError') {
                        helpMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º';
                    }
                    
                    this.setStatus(`‚ùå ${error.message}. ${helpMessage}`, 'error');
                }
            }
            
            async startRecording() {
                try {
                    this.log('–ù–∞—á–∏–Ω–∞—é –∑–∞–ø–∏—Å—å...');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4'
                    });
                    
                    this.audioChunks = [];
                    this.isRecording = true;
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                            this.log(`–ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ —á–∞–Ω–∫: ${event.data.size} –±–∞–π—Ç`);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        this.log('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                        this.processAudio();
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    this.mediaRecorder.onerror = (event) => {
                        this.log(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${event.error}`, 'error');
                    };
                    
                    this.mediaRecorder.start(1000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                    
                    this.setStatus('üî¥ –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å... –ì–æ–≤–æ—Ä–∏—Ç–µ!', 'info');
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
                    
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`, 'error');
                    this.setStatus(`‚ùå ${error.message}`, 'error');
                }
            }
            
            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.startBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    this.setStatus('‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∞—É–¥–∏–æ...', 'info');
                }
            }
            
            processAudio() {
                if (this.audioChunks.length === 0) {
                    this.log('–ù–µ—Ç –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏', 'error');
                    this.setStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –∞—É–¥–∏–æ', 'error');
                    return;
                }
                
                const audioBlob = new Blob(this.audioChunks, { 
                    type: this.mediaRecorder.mimeType || 'audio/webm' 
                });
                
                this.log(`–°–æ–∑–¥–∞–Ω –∞—É–¥–∏–æ —Ñ–∞–π–ª: ${audioBlob.size} –±–∞–π—Ç, —Ç–∏–ø: ${audioBlob.type}`);
                
                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const url = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `voice-test-${Date.now()}.webm`;
                a.textContent = '–°–∫–∞—á–∞—Ç—å –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–π —Ñ–∞–π–ª';
                a.style.display = 'block';
                a.style.marginTop = '10px';
                
                this.log.appendChild(a);
                
                this.setStatus('‚úÖ –ê—É–¥–∏–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.', 'success');
                this.log('–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                
                // –ú–æ–∂–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                this.sendToServer(audioBlob);
            }
            
            async sendToServer(audioBlob) {
                try {
                    this.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –∞—É–¥–∏–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
                    
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'voice-test.webm');
                    formData.append('sessionId', 'voice-test-' + Date.now());
                    
                    const response = await fetch('/api/voice-message', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.log('‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω');
                        this.log(`–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: "${data.transcription || '–Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ'}"`);
                        
                        if (data.message) {
                            this.log(`–û—Ç–≤–µ—Ç GPT: ${data.message}`);
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ${error.message}`, 'error');
                    this.log('–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω');
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            new VoiceTester();
        });
    </script>
</body>
</html> 