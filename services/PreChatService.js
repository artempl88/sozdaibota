const PreChatForm = require('../models/PreChatForm');
const crypto = require('crypto');

class PreChatService {
    constructor() {
        this.initPrompts();
    }

    initPrompts() {
        this.systemPrompts = {
            base: `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é Telegram-–±–æ—Ç–æ–≤ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞.

–ü–†–ò–ù–¶–ò–ü –†–ê–ë–û–¢–´: "–û–¢ –ü–†–û–°–¢–û–ì–û –ö –°–õ–û–ñ–ù–û–ú–£"
1. –°–ù–ê–ß–ê–õ–ê - –≤—ã—è—Å–Ω–∏ –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–º–µ–Ω—é, –∫–æ–º–∞–Ω–¥—ã, –ø—Ä–æ—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã)
2. –ó–ê–¢–ï–ú - –æ–±—Å—É–¥–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (CRM, –ø–ª–∞—Ç–µ–∂–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)  
3. –ü–û–¢–û–ú - –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (AI, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)

–ö–û–ù–¢–ï–ö–°–¢ –û–ë–©–ï–ù–ò–Ø:
- –ö–ª–∏–µ–Ω—Ç —É–∂–µ –∑–∞–ø–æ–ª–Ω–∏–ª –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–Ω–∫–µ—Ç—É
- –£ —Ç–µ–±—è –µ—Å—Ç—å –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ –∏ –µ–≥–æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è—Ö
- –¢–≤–æ—è —Ü–µ–ª—å: –ø–æ—à–∞–≥–æ–≤–æ —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
- –ù–∞—á–∏–Ω–∞–π —Å –ø—Ä–æ—Å—Ç—ã—Ö, –ø–æ–Ω—è—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–º —Ç–µ–º–∞–º
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏
- –ù–ï –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –∫–ª–∏–µ–Ω—Ç–∞ —Å–ª–æ–∂–Ω—ã–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏ –≤ –Ω–∞—á–∞–ª–µ

–≠–¢–ê–ü–´ –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò:
–≠–¢–ê–ü 1 (–ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª):
- –ß—Ç–æ –±–æ—Ç –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?
- –ö–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∫–Ω–æ–ø–∫–∏ –Ω—É–∂–Ω—ã?
- –ö–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é?
- –ö–∞–∫–∏–µ –ø—Ä–æ—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã?

–≠–¢–ê–ü 2 (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏):
- –ù—É–∂–Ω—ã –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ä–∞—Å—Å—ã–ª–∫–∏?
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Å–≤—è–∑—å —Å CRM/–±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö?
- –ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è?
- –ù—É–∂–Ω–∞ –ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∞–π—Ç–æ–º/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º?

–≠–¢–ê–ü 3 (–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏):
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ò–ò (ChatGPT, Claude)
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã
- –°–ª–æ–∂–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è`,

            industrySpecific: {
                'e-commerce': `–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: E-COMMERCE

–≠–¢–ê–ü 1 - –ë–ê–ó–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ:
- –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏–ª–∏ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏?)
- –ö–æ—Ä–∑–∏–Ω–∞ (–Ω—É–∂–Ω–∞ –ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å?)
- –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—Ç—å?)
- –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤ (–Ω—É–∂–Ω–æ –ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ?)

–≠–¢–ê–ü 2 - –ò–ù–¢–ï–ì–†–ê–¶–ò–ò:
- –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (–∫–∞–∫–∏–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?)
- –°–∫–ª–∞–¥—Å–∫–æ–π —É—á—ë—Ç (–µ—Å—Ç—å –ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞?)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º (SMS, email?)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∞–π—Ç–æ–º (–Ω—É–∂–Ω–∞ –ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è?)

–≠–¢–ê–ü 3 - –ü–†–û–î–í–ò–ù–£–¢–´–ï –§–£–ù–ö–¶–ò–ò:
- –ò–ò-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
- –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –±–∞–ª–ª–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤`,

                'services': `–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –£–°–õ–£–ì–ò

–≠–¢–ê–ü 1 - –ë–ê–ó–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ:
- –ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥–∏ (–≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞?)
- –ö–∞–ª–µ–Ω–¥–∞—Ä—å (–ø—Ä–æ—Å—Ç–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ —Å–ª–æ–∂–Ω–æ–µ?)
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–ª–∏ —Ä—É—á–Ω–æ–µ?)
- –û—Ç–º–µ–Ω–∞/–ø–µ—Ä–µ–Ω–æ—Å (–∫–∞–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞?)

–≠–¢–ê–ü 2 - –ò–ù–¢–ï–ì–†–ê–¶–ò–ò:
- CRM —Å–∏—Å—Ç–µ–º–∞ (–∫–∞–∫—É—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ?)
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º (–∑–∞ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤?)
- –û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –∏–ª–∏ –ø–æ–ª–Ω–∞—è?)
- –ö–∞–ª–µ–Ω–¥–∞—Ä–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (Google, Outlook?)

–≠–¢–ê–ü 3 - –ü–†–û–î–í–ò–ù–£–¢–´–ï –§–£–ù–ö–¶–ò–ò:
- –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏
- –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏`,

                'education': `–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –û–ë–†–ê–ó–û–í–ê–ù–ò–ï

–≠–¢–ê–ü 1 - –ë–ê–ó–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ:
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—Å–∞—Ö (–æ–ø–∏—Å–∞–Ω–∏–µ, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ?)
- –ó–∞–ø–∏—Å—å –Ω–∞ –∫—É—Ä—Å—ã (–æ—Ç–∫—Ä—ã—Ç–∞—è –∏–ª–∏ —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π?)
- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (—Å—Å—ã–ª–∫–∏, —Ñ–∞–π–ª—ã, –≤–∏–¥–µ–æ?)
- –û–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏ (—á–∞—Ç –∏–ª–∏ –∑–∞—è–≤–∫–∏?)

–≠–¢–ê–ü 2 - –ò–ù–¢–ï–ì–†–ê–¶–ò–ò:
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–±—É—á–µ–Ω–∏—è (LMS —Å–∏—Å—Ç–µ–º–∞?)
- –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã (—Ä–∞–∑–æ–≤–∞—è –∏–ª–∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∞?)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–Ω—è—Ç–∏—è—Ö (–∫–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å?)
- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞?)

–≠–¢–ê–ü 3 - –ü–†–û–î–í–ò–ù–£–¢–´–ï –§–£–ù–ö–¶–ò–ò:
- –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É
- –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏`,

                'default': `–£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ü–û–î–•–û–î

–≠–¢–ê–ü 1 - –ë–ê–ó–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ:
- –ì–ª–∞–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±–æ—Ç–∞ (—á—Ç–æ –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?)
- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–∫–∞–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é?)
- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è (–∫—Ç–æ –±—É–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è?)
- –ü—Ä–æ—Å—Ç—ã–µ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã (–Ω–∞ –∫–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—á–∞—Ç—å?)

–≠–¢–ê–ü 2 - –ò–ù–¢–ï–ì–†–ê–¶–ò–ò:
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∏—Å—Ç–µ–º—ã (CRM, —Å–∞–π—Ç, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?)
- –°–ø–æ—Å–æ–±—ã —Å–≤—è–∑–∏ (email, SMS, –∑–≤–æ–Ω–∫–∏?)
- –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ (—á—Ç–æ —Å–æ–±–∏—Ä–∞—Ç—å –∏ —Ö—Ä–∞–Ω–∏—Ç—å?)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∫–æ–º—É –∏ –∫–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å?)

–≠–¢–ê–ü 3 - –ü–†–û–î–í–ò–ù–£–¢–´–ï –§–£–ù–ö–¶–ò–ò:
- –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç (–¥–ª—è –∫–∞–∫–∏—Ö –∑–∞–¥–∞—á?)
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (—á—Ç–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å?)
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã (–∫–∞–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤–∞–∂–Ω—ã?)
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ?)`
            }
        };
    }

    generateSessionId() {
        return crypto.randomBytes(16).toString('hex');
    }

    async createSession(formData) {
        try {
            const sessionId = this.generateSessionId();
            
            const session = new PreChatForm({
                sessionId,
                formData,
                status: 'chat_active',
                chatHistory: [{
                    role: 'system',
                    content: '–§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞',
                    metadata: {
                        messageType: 'form_submission',
                        formData: formData
                    }
                }]
            });

            await session.save();
            return { sessionId, success: true };
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é');
        }
    }

    async getSession(sessionId) {
        try {
            return await PreChatForm.findOne({ sessionId });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
            return null;
        }
    }

    async addMessageToHistory(sessionId, role, content, metadata = {}) {
        try {
            const session = await PreChatForm.findOne({ sessionId });
            if (!session) {
                throw new Error('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }

            session.chatHistory.push({
                role,
                content,
                metadata: {
                    messageType: metadata.messageType || 'text',
                    ...metadata
                }
            });

            await session.save();
            return true;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            return false;
        }
    }

    buildContextualPrompt(formData, chatHistory = []) {
        const { name, position, industry, budget, preferredChannels, timeline } = formData;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ –æ—Ç—Ä–∞—Å–ª–∏
        let industryKey = 'default';
        const industryLower = industry.toLowerCase();
        
        if (industryLower.includes('–º–∞–≥–∞–∑–∏–Ω') || industryLower.includes('—Ç–æ—Ä–≥–æ–≤–ª—è') || industryLower.includes('–ø—Ä–æ–¥–∞–∂–∞')) {
            industryKey = 'e-commerce';
        } else if (industryLower.includes('—É—Å–ª—É–≥') || industryLower.includes('—Å–µ—Ä–≤–∏—Å') || industryLower.includes('—Å–∞–ª–æ–Ω')) {
            industryKey = 'services';
        } else if (industryLower.includes('–æ–±—Ä–∞–∑–æ–≤–∞–Ω') || industryLower.includes('–∫—É—Ä—Å') || industryLower.includes('—à–∫–æ–ª–∞')) {
            industryKey = 'education';
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
        const currentStage = this.determineConsultationStage(chatHistory);
        const stageGuidance = this.getStageGuidance(currentStage);

        const systemPrompt = `${this.systemPrompts.base}

${this.systemPrompts.industrySpecific[industryKey]}

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–õ–ò–ï–ù–¢–ï:
üë§ –ò–º—è: ${name}
üíº –î–æ–ª–∂–Ω–æ—Å—Ç—å: ${position}  
üè¢ –û—Ç—Ä–∞—Å–ª—å: ${industry}
üí∞ –ë—é–¥–∂–µ—Ç: ${budget}
üìû –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–µ –∫–∞–Ω–∞–ª—ã: ${preferredChannels.join(', ')}
‚è∞ –°—Ä–æ–∫–∏: ${timeline}

${stageGuidance}

–¢–ï–ö–£–©–ê–Ø –ó–ê–î–ê–ß–ê:
–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –∏–º–µ–Ω–∏, –ø–æ–∫–∞–∂–∏ —á—Ç–æ —Ç—ã –∏–∑—É—á–∏–ª –∞–Ω–∫–µ—Ç—É, –∏ –∑–∞–¥–∞–π –û–î–ò–ù-–î–í–ê –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ —Å–∞–º–æ–º –≤–∞–∂–Ω–æ–º, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –¥–µ—Ç–∞–ª—è–º–∏. –ù–∞—á–∏–Ω–∞–π —Å –±–∞–∑–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≥–ª—É–±–ª—è—è—Å—å –≤ –¥–µ—Ç–∞–ª–∏.`;

        // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        let conversationContext = [
            { role: 'system', content: systemPrompt }
        ];

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–∫–ª—é—á–∞—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ)
        const relevantHistory = chatHistory.filter(msg => 
            msg.metadata.messageType !== 'form_submission' && 
            msg.metadata.messageType !== 'system'
        );

        conversationContext = conversationContext.concat(relevantHistory);

        return conversationContext;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    determineConsultationStage(chatHistory) {
        const messageCount = chatHistory.filter(msg => 
            msg.role === 'user' && msg.metadata.messageType === 'text'
        ).length;

        const allMessages = chatHistory
            .filter(msg => msg.metadata.messageType === 'text')
            .map(msg => msg.content.toLowerCase())
            .join(' ');

        // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç—Ç–∞–ø–æ–≤
        const basicKeywords = ['–º–µ–Ω—é', '–∫–Ω–æ–ø–∫', '–∫–æ–º–∞–Ω–¥', '–Ω–∞—á–∞–ª', '–ø—Ä–æ—Å—Ç–æ–π', '–æ—Å–Ω–æ–≤–Ω', '–≥–ª–∞–≤–Ω'];
        const integrationKeywords = ['crm', '–ø–ª–∞—Ç', '–æ–ø–ª–∞—Ç', '—É–≤–µ–¥–æ–º–ª–µ–Ω', '—Å–∞–π—Ç', '–∏–Ω—Ç–µ–≥—Ä–∞—Ü', '–±–¥', '–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö'];
        const advancedKeywords = ['–∏–∏', 'ai', 'gpt', '–∞–Ω–∞–ª–∏—Ç–∏–∫', '–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü', '–º–∞—à–∏–Ω–Ω', '–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü'];

        const hasBasicDiscussed = basicKeywords.some(keyword => allMessages.includes(keyword));
        const hasIntegrationDiscussed = integrationKeywords.some(keyword => allMessages.includes(keyword));
        const hasAdvancedDiscussed = advancedKeywords.some(keyword => allMessages.includes(keyword));

        // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞
        if (messageCount <= 2 && !hasBasicDiscussed) {
            return 'basic'; // –ù–∞—á–∏–Ω–∞–µ–º —Å –±–∞–∑–æ–≤–æ–≥–æ
        } else if (messageCount <= 5 && hasBasicDiscussed && !hasIntegrationDiscussed) {
            return 'integration'; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º
        } else if (hasBasicDiscussed && hasIntegrationDiscussed && !hasAdvancedDiscussed) {
            return 'advanced'; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
        } else if (messageCount > 8) {
            return 'advanced'; // –ü–æ—Å–ª–µ 8 —Å–æ–æ–±—â–µ–Ω–∏–π - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —ç—Ç–∞–ø
        } else {
            return 'basic'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–∞–∑–æ–≤—ã–π
        }
    }

    // –ü–æ–ª—É—á–∞–µ–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
    getStageGuidance(stage) {
        const guidance = {
            'basic': `
üéØ –¢–ï–ö–£–©–ò–ô –≠–¢–ê–ü: –ë–ê–ó–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –ø—Ä–æ—Å—Ç—ã—Ö, –ø–æ–Ω—è—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö:
- –ß—Ç–æ –±–æ—Ç –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?
- –ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∫–Ω–æ–ø–∫–∏ –Ω—É–∂–Ω—ã?
- –ö–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é?
- –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ª–æ–∂–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ
- –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º, –∏–∑–±–µ–≥–∞–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤`,

            'integration': `
üîó –¢–ï–ö–£–©–ò–ô –≠–¢–ê–ü: –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
–ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ–±—Å—É–∂–¥—ë–Ω, —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º:
- –ù—É–∂–Ω—ã –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ä–∞—Å—Å—ã–ª–∫–∏?
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Å–≤—è–∑—å —Å CRM –∏–ª–∏ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö?
- –ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è?
- –ù—É–∂–Ω–∞ –ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–∞–π—Ç–æ–º/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º?
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π`,

            'advanced': `
üöÄ –¢–ï–ö–£–©–ò–ô –≠–¢–ê–ü: –ü–†–û–î–í–ò–ù–£–¢–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò
–ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–±—Å—É–∂–¥–µ–Ω—ã, –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤—ã—Å–æ–∫–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ò–ò (ChatGPT, Claude, Whisper)
- –°–∏—Å—Ç–µ–º—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –±–∏–∑–Ω–µ—Å-–æ—Ç—á—ë—Ç–æ–≤
- –°–ª–æ–∂–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã`
        };

        return guidance[stage] || guidance['basic'];
    }

    async updateLeadScore(sessionId) {
        try {
            const session = await PreChatForm.findOne({ sessionId });
            if (!session) return;

            let score = 0;
            const { budget, timeline, position, industry } = session.formData;

            // –û—Ü–µ–Ω–∫–∞ –±—é–¥–∂–µ—Ç–∞ (0-3 –±–∞–ª–ª–∞)
            const budgetScores = {
                '–¥–æ 20 000‚ÇΩ': 1,
                '20 000 - 50 000‚ÇΩ': 2,
                '50 000 - 100 000‚ÇΩ': 2.5,
                '100 000 - 200 000‚ÇΩ': 3,
                '—Å–≤—ã—à–µ 200 000‚ÇΩ': 3
            };
            score += budgetScores[budget] || 1;

            // –û—Ü–µ–Ω–∫–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ (0-2 –±–∞–ª–ª–∞)
            const timelineScores = {
                '—Å—Ä–æ—á–Ω–æ (1-3 –¥–Ω—è)': 2,
                '–±—ã—Å—Ç—Ä–æ (–Ω–µ–¥–µ–ª—è)': 1.5,
                '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ (2-3 –Ω–µ–¥–µ–ª–∏)': 1,
                '–Ω–µ —Å–ø–µ—à–∏–º (–º–µ—Å—è—Ü+)': 0.5
            };
            score += timelineScores[timeline] || 1;

            // –û—Ü–µ–Ω–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ (0-2 –±–∞–ª–ª–∞)
            const positionLower = position.toLowerCase();
            if (positionLower.includes('–¥–∏—Ä–µ–∫—Ç–æ—Ä') || positionLower.includes('—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å') || positionLower.includes('–≤–ª–∞–¥–µ–ª–µ—Ü')) {
                score += 2;
            } else if (positionLower.includes('–º–µ–Ω–µ–¥–∂–µ—Ä') || positionLower.includes('—É–ø—Ä–∞–≤–ª—è—é—â–∏–π')) {
                score += 1.5;
            } else {
                score += 1;
            }

            // –û—Ü–µ–Ω–∫–∞ –æ—Ç—Ä–∞—Å–ª–∏ (0-1 –±–∞–ª–ª)
            const highValueIndustries = ['—Ñ–∏–Ω–∞–Ω—Å—ã', '–º–µ–¥–∏—Ü–∏–Ω–∞', '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', '–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', 'e-commerce'];
            if (highValueIndustries.some(ind => industry.toLowerCase().includes(ind))) {
                score += 1;
            } else {
                score += 0.5;
            }

            // –û—Ü–µ–Ω–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ —á–∞—Ç–µ (0-2 –±–∞–ª–ª–∞)
            const messageCount = session.chatHistory.filter(msg => msg.role === 'user').length;
            if (messageCount >= 5) {
                score += 2;
            } else if (messageCount >= 3) {
                score += 1.5;
            } else if (messageCount >= 1) {
                score += 1;
            }

            session.leadScore = Math.min(10, Math.round(score * 10) / 10);
            await session.save();

            return session.leadScore;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–¥-—Å–∫–æ—Ä–∞:', error);
            return 0;
        }
    }

    validateFormData(formData) {
        const required = ['name', 'contactInfo', 'position', 'industry', 'budget', 'preferredChannels', 'timeline'];
        const missing = required.filter(field => !formData[field]);
        
        if (missing.length > 0) {
            return { valid: false, missing };
        }

        if (!Array.isArray(formData.preferredChannels) || formData.preferredChannels.length === 0) {
            return { valid: false, error: '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏' };
        }

        const validBudgets = ['–¥–æ 20 000‚ÇΩ', '20 000 - 50 000‚ÇΩ', '50 000 - 100 000‚ÇΩ', '100 000 - 200 000‚ÇΩ', '—Å–≤—ã—à–µ 200 000‚ÇΩ'];
        if (!validBudgets.includes(formData.budget)) {
            return { valid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±—é–¥–∂–µ—Ç' };
        }

        const validTimelines = ['—Å—Ä–æ—á–Ω–æ (1-3 –¥–Ω—è)', '–±—ã—Å—Ç—Ä–æ (–Ω–µ–¥–µ–ª—è)', '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ (2-3 –Ω–µ–¥–µ–ª–∏)', '–Ω–µ —Å–ø–µ—à–∏–º (–º–µ—Å—è—Ü+)'];
        if (!validTimelines.includes(formData.timeline)) {
            return { valid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—Ä–æ–∫–∏' };
        }

        return { valid: true };
    }

    async getAnalytics() {
        try {
            const totalSessions = await PreChatForm.countDocuments();
            const activeChats = await PreChatForm.countDocuments({ status: 'chat_active' });
            const qualifiedLeads = await PreChatForm.countDocuments({ leadScore: { $gte: 6 } });
            
            const avgScore = await PreChatForm.aggregate([
                { $group: { _id: null, avgScore: { $avg: "$leadScore" } } }
            ]);

            const industryStats = await PreChatForm.aggregate([
                { $group: { _id: "$formData.industry", count: { $sum: 1 } } },
                { $sort: { count: -1 } }
            ]);

            return {
                totalSessions,
                activeChats,
                qualifiedLeads,
                avgScore: avgScore[0]?.avgScore || 0,
                industryStats,
                conversionRate: totalSessions > 0 ? (qualifiedLeads / totalSessions * 100).toFixed(1) : 0
            };
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
            return null;
        }
    }
}

module.exports = PreChatService; 