#!/bin/bash

echo "๐ ะะตัะตะทะฐะฟััะบ ัะตัะฒะตัะฐ sozdaibota.ru..."
echo "======================================"

# ะััะฐะฝะพะฒะบะฐ ะฟัะพัะตััะพะฒ Node.js
echo "๐ ะััะฐะฝะพะฒะบะฐ ัะตะบััะธั ะฟัะพัะตััะพะฒ..."
pkill -f "node.*start.js" || echo "ะัะพัะตััั ะฝะต ะฝะฐะนะดะตะฝั"
pkill -f "npm.*start" || echo "npm ะฟัะพัะตััั ะฝะต ะฝะฐะนะดะตะฝั"

# ะะดะตะผ ะทะฐะฒะตััะตะฝะธั ะฟัะพัะตััะพะฒ
sleep 2

# ะัะพะฒะตััะตะผ ััะพ ะฟัะพัะตััั ะพััะฐะฝะพะฒะปะตะฝั
if pgrep -f "node.*start.js" > /dev/null; then
    echo "โ๏ธ ะัะธะฝัะดะธัะตะปัะฝะฐั ะพััะฐะฝะพะฒะบะฐ..."
    pkill -9 -f "node.*start.js"
    sleep 1
fi

echo "โ ะัะพัะตััั ะพััะฐะฝะพะฒะปะตะฝั"

# ะฃััะฐะฝะพะฒะบะฐ/ะพะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
npm install --production

# ะะฐะฟััะบ ัะตัะฒะตัะฐ
echo "๐ ะะฐะฟััะบ ัะตัะฒะตัะฐ..."
nohup npm start > server.log 2>&1 &

# ะะดะตะผ ะทะฐะฟััะบะฐ
sleep 3

# ะัะพะฒะตััะตะผ ััะพ ัะตัะฒะตั ะทะฐะฟัััะธะปัั
if pgrep -f "node.*start.js" > /dev/null; then
    echo "โ ะกะตัะฒะตั ััะฟะตัะฝะพ ะฟะตัะตะทะฐะฟััะตะฝ!"
    echo "๐ URL: https://sozdaibota.ru"
    echo "๐ ะะพะณะธ: tail -f server.log"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ: cat server.log"
    exit 1
fi

echo "======================================"
echo "๐ฏ ะะตัะตะทะฐะฟััะบ ะทะฐะฒะตััะตะฝ!" 