const logger = require('../utils/logger');
const GPTService = require('./GPTService');

class EstimateService {
    constructor() {
        this.pricingSystem = {
            hourlyRate: 2000,
            minProjectCost: 15000,
            // –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            baseComponents: {
                '–±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–æ—Ç–∞': 8,
                '—Å–∏—Å—Ç–µ–º–∞ –∫–æ–º–∞–Ω–¥ –∏ –º–µ–Ω—é': 4,
                '–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API Telegram': 2,
                '–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π': 6,
                '–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å': 12,
                '—Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è': 3,
                '–¥–µ–ø–ª–æ–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞': 4
            },
            
            // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
            features: {
                // E-commerce
                '–∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤': 12,
                '–∫–æ—Ä–∑–∏–Ω–∞': 8,
                '–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞': 6,
                '–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π': 10,
                '—Å–∏—Å—Ç–µ–º–∞ —Å–∫–∏–¥–æ–∫': 6,
                '–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏': 8,
                
                // –ó–∞–ø–∏—Å–∏ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                '–∫–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–∏': 10,
                '–≤—ã–±–æ—Ä —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞': 6,
                '–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è': 4,
                '–æ—Ç–º–µ–Ω–∞/–ø–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏': 4,
                '–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM': 12,
                
                // AI –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
                '–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GPT': 8,
                '–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π': 10,
                '—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞': 12,
                '–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤': 8,
                '–¥–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏': 16,
                
                // –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
                '—Ä–∞—Å—Å—ã–ª–∫–∏': 6,
                '–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è': 8,
                '–º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å': 10,
                '—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è': 4,
                
                // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ
                '–Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞': 20,
                '—Ä–∞—Å—á–µ—Ç –≥–æ—Ä–æ—Å–∫–æ–ø–∞': 16,
                '–∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏': 12,
                '–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ —Ñ–æ—Ç–æ': 24
            },
            
            // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            complexity: {
                '–ø—Ä–æ—Å—Ç–æ–π': 1.0,
                '—Å—Ä–µ–¥–Ω–∏–π': 1.3,
                '—Å–ª–æ–∂–Ω—ã–π': 1.6,
                '–æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π': 2.0
            },
            
            // –°—Ä–æ—á–Ω–æ—Å—Ç—å
            urgency: {
                '—Å—Ç–∞–Ω–¥–∞—Ä—Ç': 1.0,
                '—Å—Ä–æ—á–Ω–æ': 1.3,
                '–æ—á–µ–Ω—å —Å—Ä–æ—á–Ω–æ': 1.5
            }
        };
    }

    // –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ GPT-4
    async calculateProjectEstimate(requirements, conversation = []) {
        try {
            logger.info('–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç —Å–º–µ—Ç—ã', { requirementsLength: requirements.length });

            // –°–Ω–∞—á–∞–ª–∞ –ø–∞—Ä—Å–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
            const detectedFeatures = this.parseRequirements(requirements);
            
            // –ü—Ä–æ–º–ø—Ç –¥–ª—è GPT-4 –¥–ª—è —Ç–æ—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
            const estimationPrompt = `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —Ç–µ—Ö–ª–∏–¥ —Å 10+ –ª–µ—Ç –æ–ø—ã—Ç–∞ –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ Telegram-–±–æ—Ç–æ–≤.

–ó–ê–î–ê–ß–ê: –û—Ü–µ–Ω–∏ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤ —á–∞—Å–∞—Ö –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

–ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê:
${requirements}

–ë–ê–ó–û–í–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ (—á–∞—Å—ã):
${JSON.stringify(this.pricingSystem.baseComponents, null, 2)}

–¢–ò–ü–û–í–´–ï –§–£–ù–ö–¶–ò–ò (—á–∞—Å—ã):
${JSON.stringify(this.pricingSystem.features, null, 2)}

–ü–†–ê–í–ò–õ–ê –û–¶–ï–ù–ö–ò:
1. –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ - –∏—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ç–æ–≤—É—é –æ—Ü–µ–Ω–∫—É
2. –î–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π - –æ—Ü–µ–Ω–∏ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏
3. –£—á—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏
4. –î–æ–±–∞–≤—å 20% –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫—É
5. –î–æ–±–∞–≤—å 10% –Ω–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{
    "projectName": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞",
    "components": [
        {"name": "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç", "hours": 10, "description": "–ß—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç"}
    ],
    "totalHours": 100,
    "complexity": "—Å—Ä–µ–¥–Ω–∏–π",
    "risks": ["—Ä–∏—Å–∫ 1", "—Ä–∏—Å–∫ 2"],
    "timeline": "2-3 –Ω–µ–¥–µ–ª–∏",
    "recommendations": ["—Å–æ–≤–µ—Ç 1", "—Å–æ–≤–µ—Ç 2"]
}`;

            try {
                const messages = [
                    { role: 'system', content: estimationPrompt },
                    { role: 'user', content: `–û—Ü–µ–Ω–∏ –ø—Ä–æ–µ–∫—Ç: ${requirements}` }
                ];

                const response = await GPTService.chat(messages);
                const estimate = JSON.parse(response);
                
                // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                const cost = estimate.totalHours * this.pricingSystem.hourlyRate;
                
                const result = {
                    ...estimate,
                    hourlyRate: this.pricingSystem.hourlyRate,
                    totalCost: cost,
                    detectedFeatures: detectedFeatures,
                    costBreakdown: estimate.components.map(c => ({
                        ...c,
                        cost: c.hours * this.pricingSystem.hourlyRate
                    }))
                };

                logger.info('–°–º–µ—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —á–µ—Ä–µ–∑ GPT', { 
                    totalCost: result.totalCost, 
                    totalHours: result.totalHours 
                });

                return result;

            } catch (gptError) {
                logger.warn('–û—à–∏–±–∫–∞ GPT —Ä–∞—Å—á–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback:', gptError.message);
                return this.fallbackEstimate(requirements, detectedFeatures);
            }

        } catch (error) {
            logger.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å–º–µ—Ç—ã:', error);
            return this.fallbackEstimate(requirements);
        }
    }

    // –†–µ–∑–µ—Ä–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑ GPT-4
    fallbackEstimate(requirements, detectedFeatures = null) {
        try {
            const lower = requirements.toLowerCase();
            let totalHours = 0;
            let components = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            Object.entries(this.pricingSystem.baseComponents).forEach(([name, hours]) => {
                totalHours += hours;
                components.push({ 
                    name, 
                    hours, 
                    description: '–ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è',
                    cost: hours * this.pricingSystem.hourlyRate 
                });
            });
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–º –∑–∞–Ω–æ–≤–æ
            const features = detectedFeatures || this.parseRequirements(requirements);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
            features.forEach(feature => {
                const hours = this.pricingSystem.features[feature] || 5;
                totalHours += hours;
                components.push({ 
                    name: feature, 
                    hours, 
                    description: '–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è',
                    cost: hours * this.pricingSystem.hourlyRate 
                });
            });
            
            // –ú–∏–Ω–∏–º—É–º 40 —á–∞—Å–æ–≤ –Ω–∞ –ª—é–±–æ–π –ø—Ä–æ–µ–∫—Ç
            totalHours = Math.max(totalHours, 40);
            
            const result = {
                projectName: 'Telegram-–±–æ—Ç',
                components,
                totalHours,
                totalCost: totalHours * this.pricingSystem.hourlyRate,
                complexity: '—Å—Ä–µ–¥–Ω–∏–π',
                timeline: `${Math.ceil(totalHours / 40)} –Ω–µ–¥–µ–ª—å`,
                detectedFeatures: features,
                costBreakdown: components
            };

            logger.info('–°–º–µ—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —á–µ—Ä–µ–∑ fallback', { 
                totalCost: result.totalCost, 
                totalHours: result.totalHours 
            });

            return result;

        } catch (error) {
            logger.error('–û—à–∏–±–∫–∞ fallback —Ä–∞—Å—á–µ—Ç–∞:', error);
            return this.getMinimalEstimate();
        }
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏–∑ —Ç–µ–∫—Å—Ç–∞
    parseRequirements(text) {
        const lower = text.toLowerCase();
        const detectedFeatures = [];
        
        // –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        const improvedPatterns = {
            // E-commerce
            '–∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤': /–∫–∞—Ç–∞–ª–æ–≥[–∞-—è\s]*—Ç–æ–≤–∞—Ä|—Ç–æ–≤–∞—Ä[–∞-—è\s]*–∫–∞—Ç–∞–ª–æ–≥|—Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤|–∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç/i,
            '–∫–æ—Ä–∑–∏–Ω–∞': /–∫–æ—Ä–∑–∏–Ω[–∞–µ—É]|–¥–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–∫–∞–∑|–æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑|cart/i,
            '–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π': /(–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è[–∞-—è\s]*)?–ø–ª–∞—Ç[–µ—ë]–∂|–æ–ø–ª–∞—Ç[–∞–µ—É]|payment|pay|–∫–∞—Å—Å[–∞–µ—É]/i,
            '—Å–∏—Å—Ç–µ–º–∞ —Å–∫–∏–¥–æ–∫': /—Å–∫–∏–¥–∫[–∞–∏–µ—É]|–ø—Ä–æ–º–æ–∫–æ–¥|discount|–∞–∫—Ü–∏[—è–∏]/i,
            '–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏': /–æ—Ç—Å–ª–µ–∂–∏–≤[–∞-—è]*–¥–æ—Å—Ç–∞–≤–∫|—Ç—Ä–µ–∫[–∞-—è]*–¥–æ—Å—Ç–∞–≤–∫|—Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏/i,
            
            // –ó–∞–ø–∏—Å–∏ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ  
            '–∫–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–∏': /–∫–∞–ª–µ–Ω–¥–∞—Ä[—å—è–∏][–∞-—è\s]*–∑–∞–ø–∏—Å|–∑–∞–ø–∏—Å[–∞–µ–∏—å][–∞-—è\s]*–∫–∞–ª–µ–Ω–¥–∞—Ä|—Ä–∞—Å–ø–∏—Å–∞–Ω–∏[–µ—è]/i,
            '–≤—ã–±–æ—Ä —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞': /–≤—ã–±–æ—Ä[–∞-—è\s]*—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç|—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç[–∞-—è\s]*–≤—ã–±–æ—Ä|–º–∞—Å—Ç–µ—Ä[–∞-—è\s]*–≤—ã–±–æ—Ä/i,
            '–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è': /–Ω–∞–ø–æ–º–∏–Ω[–∞-—è]*|—É–≤–µ–¥–æ–º–ª–µ–Ω–∏[—è–µ–∏]|notification|reminder/i,
            '–æ—Ç–º–µ–Ω–∞/–ø–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏': /–æ—Ç–º–µ–Ω[–∞–µ—É][–∞-—è\s]*–∑–∞–ø–∏—Å|–ø–µ—Ä–µ–Ω–æ—Å[–∞-—è\s]*–∑–∞–ø–∏—Å|–æ—Ç–ª–æ–∂–∏—Ç—å/i,
            '–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM': /crm|–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è[–∞-—è\s]*crm|—Å–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞/i,
            
            // AI –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
            '–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GPT': /gpt|chatgpt|ai|–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç|—É–º–Ω[—ã–∞—è–æ–µ][–∞-—è\s]*–±–æ—Ç/i,
            '–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π': /–æ–±—Ä–∞–±–æ—Ç–∫[–∞–µ—É][–∞-—è\s]*–∏–∑–æ–±—Ä–∞–∂–µ–Ω|—Ñ–æ—Ç–æ[–∞-—è\s]*–æ–±—Ä–∞–±–æ—Ç–∫|–∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ/i,
            '—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞': /—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω[–∞-—è]*–≥–æ–ª–æ—Å|–≥–æ–ª–æ—Å[–∞-—è\s]*—Ä–∞—Å–ø–æ–∑–Ω–∞–≤|voice recognition/i,
            '–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤': /–≥–µ–Ω–µ—Ä–∞—Ü[–∞-—è]*–æ—Ç—á—ë—Ç|—Å–æ–∑–¥–∞–Ω[–∞-—è]*–æ—Ç—á—ë—Ç|–æ—Ç—á—ë—Ç–Ω–æ—Å—Ç/i,
            '–¥–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏': /–¥–∞—à–±–æ—Ä–¥|dashboard|–∞–Ω–∞–ª–∏—Ç–∏–∫[–∞–µ—É]|—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫[–∞–µ—É]/i,
            
            // –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
            '—Ä–∞—Å—Å—ã–ª–∫–∏': /—Ä–∞—Å—Å—ã–ª–∫[–∞–µ–∏—É]|–º–∞—Å—Å–æ–≤[–∞-—è]*–æ—Ç–ø—Ä–∞–≤–∫|newsletter|mailing/i,
            '–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è': /–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü[–∞-—è]*|–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω[–∞-—è]*–ø–æ–¥—Ö–æ–¥|personalization/i,
            '–º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å': /–º–Ω–æ–≥–æ—è–∑—ã—á–Ω[–∞-—è]*|–º—É–ª—å—Ç–∏—è–∑—ã—á–Ω[–∞-—è]*|–ø–µ—Ä–µ–≤–æ–¥|translation/i,
            '—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è': /—É–≤–µ–¥–æ–º–ª–µ–Ω–∏[—è–µ–∏]|–ø—É—à[–∞-—è\s]*—É–≤–µ–¥–æ–º–ª–µ–Ω–∏/i,
            
            // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            '–Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞': /–Ω–∞—Ç–∞–ª—å–Ω[–∞-—è]*–∫–∞—Ä—Ç|–∫–∞—Ä—Ç[–∞–µ—É][–∞-—è\s]*—Ä–æ–∂–¥–µ–Ω/i,
            '—Ä–∞—Å—á–µ—Ç –≥–æ—Ä–æ—Å–∫–æ–ø–∞': /–≥–æ—Ä–æ—Å–∫–æ–ø|–∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫[–∞-—è]*—Ä–∞—Å—á—ë—Ç|–ø—Ä–æ–≥–Ω–æ–∑[–∞-—è\s]*–∑–≤—ë–∑–¥/i,
            '–∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏': /—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç[—å–∏]|–ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫[–∞-—è]*–∞–Ω–∞–ª–∏–∑|compatibility/i,
            '–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ —Ñ–æ—Ç–æ': /–∞–Ω–∞–ª–∏–∑[–∞-—è\s]*–ø–æ —Ñ–æ—Ç–æ|—Ñ–æ—Ç–æ[–∞-—è\s]*–∞–Ω–∞–ª–∏–∑|–∑–∞–≥—Ä—É–∑[–∞-—è]*—Ñ–æ—Ç–æ/i
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
        Object.entries(improvedPatterns).forEach(([feature, pattern]) => {
            if (pattern.test(text)) {
                detectedFeatures.push(feature);
            }
        });
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ pricing system
        Object.keys(this.pricingSystem.features).forEach(feature => {
            if (!detectedFeatures.includes(feature)) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤
                const featureWords = feature.toLowerCase().split(' ');
                const textWords = lower.split(/\s+/);
                
                const foundAllWords = featureWords.every(word => 
                    textWords.some(textWord => textWord.includes(word) && word.length > 2)
                );
                
                if (foundAllWords) {
                    detectedFeatures.push(feature);
                }
            }
        });
        
        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        return [...new Set(detectedFeatures)];
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ—Ç—ã
    formatEstimateMessage(estimate) {
        const totalCost = Number(estimate.totalCost) || 0;
        const totalHours = Number(estimate.totalHours) || 0;
        
        return `üí∞ **–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞**

üìã **${estimate.projectName}**

‚è±Ô∏è **–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** ${totalHours} —á–∞—Å–æ–≤ (${estimate.timeline})

üíµ **–°—Ç–æ–∏–º–æ—Å—Ç—å:** ${totalCost.toLocaleString('ru-RU')} —Ä—É–±.
*–ò–∑ —Ä–∞—Å—á–µ—Ç–∞ ${this.pricingSystem.hourlyRate} —Ä—É–±/—á–∞—Å*

üìä **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º:**
${estimate.costBreakdown && estimate.costBreakdown.length > 0 ? 
    estimate.costBreakdown.map(c => {
        const hours = Number(c.hours) || 0;
        const cost = Number(c.cost) || 0;
        return `‚Ä¢ ${c.name}: ${hours}—á = ${cost.toLocaleString('ru-RU')} —Ä—É–±.`;
    }).join('\n') : '–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}

‚ö° **–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞:** ${estimate.complexity}

${estimate.risks && estimate.risks.length > 0 ? 
`‚ö†Ô∏è **–†–∏—Å–∫–∏:**
${estimate.risks.map(r => `‚Ä¢ ${r}`).join('\n')}` : ''}

${estimate.recommendations && estimate.recommendations.length > 0 ?
`üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
${estimate.recommendations.map(r => `‚Ä¢ ${r}`).join('\n')}` : ''}

---
‚úÖ –≠—Ç–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞. –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –Ω–∞ ¬±15% –ø–æ—Å–ª–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¢–ó.`;
    }

    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–º–µ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    getMinimalEstimate() {
        return {
            projectName: '–ë–∞–∑–æ–≤—ã–π Telegram-–±–æ—Ç',
            components: [
                { name: '–ë–∞–∑–æ–≤–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞', hours: 40, description: '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª' }
            ],
            totalHours: 40,
            totalCost: 80000,
            complexity: '–ø—Ä–æ—Å—Ç–æ–π',
            timeline: '1 –Ω–µ–¥–µ–ª—è',
            detectedFeatures: [],
            costBreakdown: [
                { name: '–ë–∞–∑–æ–≤–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞', hours: 40, cost: 80000 }
            ]
        };
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    getQuickEstimate(category) {
        const quickEstimates = {
            'simple': { cost: 25000, description: '–ü—Ä–æ—Å—Ç–æ–π –±–æ—Ç —Å –±–∞–∑–æ–≤—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏' },
            'medium': { cost: 50000, description: '–ë–æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏' },
            'complex': { cost: 100000, description: '–°–ª–æ–∂–Ω—ã–π –±–æ—Ç —Å –ò–ò –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π' }
        };

        return quickEstimates[category] || quickEstimates['medium'];
    }
}

module.exports = new EstimateService(); 